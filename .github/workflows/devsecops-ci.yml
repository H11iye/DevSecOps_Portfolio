name: DevSecOps CI Pipeline

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  codeql-sast:
    name: SAST - CodeQL
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v4


  gitleaks-secret-scan:
    name: Secret Scan - Gitleaks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  trivy-fs-scan:
    name: Dependency Scan - Trivy FS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.0_Linux-64bit.deb

      - name: Trivy FS scan
        run: |
          echo "## ðŸ“¦ Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          trivy fs . \
            --severity HIGH,CRITICAL \
            --format table \
            --exit-code ${{ github.event_name == 'push' && '1' || '0' }} \
            | tee /tmp/trivy-fs.txt

          cat /tmp/trivy-fs.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Trivy FS JSON
        run: |
          trivy fs . --severity HIGH,CRITICAL --format json -o trivy-fs.json
      
      - name: Generate Markdown Table
        run: |
          echo "## ðŸ“¦ Dependency Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Vulnerability | Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|---------|----------|" >> $GITHUB_STEP_SUMMARY

          jq -r '
            .Results[].Vulnerabilities[]? |
            "| \(.Severity) | \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) |"
          ' trivy-fs.json >> $GITHUB_STEP_SUMMARY

    # 1ï¸âƒ£ SARIF for GitHub Security tab
      - name: Trivy filesystem scan (SARIF)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-fs.sarif
          # exit-code: ${{ github.event_name == 'push' && '1' || '0' }}
          exit-code: 0

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-fs.sarif

      # 2ï¸âƒ£ JSON for table rendering
      - name: Trivy FS Scan (JSON)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: trivy-fs.json
          severity: HIGH,CRITICAL
          exit-code: 0



  docker-image-scan:
    name: Container Scan - Trivy Image
    runs-on: ubuntu-latest
    needs: [trivy-fs-scan, gitleaks-secret-scan]

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t devsecops:latest .

      - name: Trivy image scan (SARIF)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: devsecops:latest
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-image.sarif
          # exit-code: ${{ github.event_name == 'push' && '1' || '0' }}
          exit-code: 0

      - name: Upload image SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image.sarif

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.0_Linux-64bit.deb

      - name: Trivy image scan (log + summary)
        run: |
          echo "## ðŸ³ Container Image Scan Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          trivy image devsecops:latest \
            --severity HIGH,CRITICAL \
            --format table \
            --exit-code 0 | tee /tmp/trivy-table.txt

          cat /tmp/trivy-table.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

